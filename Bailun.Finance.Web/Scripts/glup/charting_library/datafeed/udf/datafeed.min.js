"use strict";function parseJSONorNot(e){if("string"!=typeof e)return e;try{return JSON.parse(JSON.parse(e))}catch(t){return JSON.parse(e)}}var Datafeeds={},windowRangTime=[0,0];Datafeeds.UDFCompatibleDatafeed=function(e,t){this._datafeedURL=e,this._configuration=void 0,this._symbolSearch=null,this._symbolsStorage=null,this._barsPulseUpdater=new Datafeeds.DataPulseUpdater(this,t||1e4),this._quotesPulseUpdater=new Datafeeds.QuotesPulseUpdater(this),this._enableLogging=!1,this._initializationFinished=!1,this._callbacks={},this._initialize()},Datafeeds.UDFCompatibleDatafeed.prototype.defaultConfiguration=function(){return{supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1}},Datafeeds.UDFCompatibleDatafeed.prototype.getServerTime=function(e){this._configuration.supports_time&&this._send(this._datafeedURL+"/time",{}).done(function(t){var s=+t;isNaN(s)||e(s)}).fail(function(){})},Datafeeds.UDFCompatibleDatafeed.prototype.on=function(e,t){return this._callbacks.hasOwnProperty(e)||(this._callbacks[e]=[]),this._callbacks[e].push(t),this},Datafeeds.UDFCompatibleDatafeed.prototype._fireEvent=function(e,t){if(this._callbacks.hasOwnProperty(e)){for(var s=this._callbacks[e],a=0;a<s.length;++a)s[a](t);this._callbacks[e]=[]}},Datafeeds.UDFCompatibleDatafeed.prototype.onInitialized=function(){this._initializationFinished=!0,this._fireEvent("initialized")},Datafeeds.UDFCompatibleDatafeed.prototype._logMessage=function(e){if(this._enableLogging){var t=new Date;console.log(t.toLocaleTimeString()+"."+t.getMilliseconds()+"> "+e)}},Datafeeds.UDFCompatibleDatafeed.prototype._send=function(e,t){var s=e;if(t)for(var a=0;a<Object.keys(t).length;++a){var i=Object.keys(t)[a],o=encodeURIComponent(t[i]);s+=(0===a?"?":"&")+i+"="+o}return this._logMessage("New request: "+s),$.ajax({type:"GET",url:s,contentType:"text/plain"})},Datafeeds.UDFCompatibleDatafeed.prototype._initialize=function(){var e=this;this._send(this._datafeedURL+"/config").done(function(t){var s=parseJSONorNot(t);e._setupWithConfiguration(s)}).fail(function(){e._setupWithConfiguration(e.defaultConfiguration())})},Datafeeds.UDFCompatibleDatafeed.prototype.onReady=function(e){var t=this;this._configuration?setTimeout(function(){e(t._configuration)},0):this.on("configuration_ready",function(){e(t._configuration)})},Datafeeds.UDFCompatibleDatafeed.prototype._setupWithConfiguration=function(e){this._configuration=e,e.exchanges||(e.exchanges=[]);var t=e.supported_resolutions||e.supportedResolutions;e.supported_resolutions=t;var s=e.symbols_types||e.symbolsTypes;if(e.symbols_types=s,!e.supports_search&&!e.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");e.supports_search||(this._symbolSearch=new Datafeeds.SymbolSearchComponent(this)),e.supports_group_request?this._symbolsStorage=new Datafeeds.SymbolsStorage(this):this.onInitialized(),this._fireEvent("configuration_ready"),this._logMessage("Initialized with "+JSON.stringify(e))},Datafeeds.UDFCompatibleDatafeed.prototype.getMarks=function(e,t,s,a,i){this._configuration.supports_marks&&this._send(this._datafeedURL+"/marks",{symbol:e.ticker.toUpperCase(),from:t,to:s,resolution:i}).done(function(e){a(parseJSONorNot(e))}).fail(function(){a([])})},Datafeeds.UDFCompatibleDatafeed.prototype.getTimescaleMarks=function(e,t,s,a,i){this._configuration.supports_timescale_marks&&this._send(this._datafeedURL+"/timescale_marks",{symbol:e.ticker.toUpperCase(),from:t,to:s,resolution:i}).done(function(e){a(parseJSONorNot(e))}).fail(function(){a([])})},Datafeeds.UDFCompatibleDatafeed.prototype.searchSymbols=function(e,t,s,a){var i=30;if(!this._configuration)return void a([]);if(this._configuration.supports_search)this._send(this._datafeedURL+"/search",{limit:i,query:e.toUpperCase(),type:s,exchange:t}).done(function(e){for(var t=parseJSONorNot(e),s=0;s<t.length;++s)t[s].params||(t[s].params=[]),t[s].exchange=t[s].exchange||"";a("undefined"==typeof t.s||"error"!==t.s?t:[])}).fail(function(){a([])});else{if(!this._symbolSearch)throw new Error("Datafeed error: inconsistent configuration (symbol search)");var o={searchString:e,exchange:t,type:s,onResultReadyCallback:a};if(this._initializationFinished)this._symbolSearch.searchSymbols(o,i);else{var n=this;this.on("initialized",function(){n._symbolSearch.searchSymbols(o,i)})}}},Datafeeds.UDFCompatibleDatafeed.prototype._symbolResolveURL="/symbols",Datafeeds.UDFCompatibleDatafeed.prototype.resolveSymbol=function(e,t,s){function a(e){var s=e;i.postProcessSymbolInfo&&(s=i.postProcessSymbolInfo(s)),i._logMessage("Symbol resolved: "+(Date.now()-o)),t(s)}var i=this;if(!this._initializationFinished)return void this.on("initialized",function(){i.resolveSymbol(e,t,s)});var o=Date.now();i._logMessage("Resolve requested"),this._configuration.supports_group_request?this._initializationFinished?this._symbolsStorage.resolveSymbol(e,a,s):this.on("initialized",function(){i._symbolsStorage.resolveSymbol(e,a,s)}):this._send(this._datafeedURL+this._symbolResolveURL,{symbol:e?e.toUpperCase():""}).done(function(e){var t=parseJSONorNot(e);t.s&&"ok"!==t.s?s("unknown_symbol"):a(t)}).fail(function(e){i._logMessage("Error resolving symbol: "+JSON.stringify([e])),s("unknown_symbol")})},Datafeeds.UDFCompatibleDatafeed.prototype._historyURL="/history",Datafeeds.UDFCompatibleDatafeed.prototype.getBars=function(e,t,s,a,i,o){function n(e){var t=parseJSONorNot(e);WindowCallback=null;var s="no_data"===t.s;if("ok"!==t.s&&!s)return void(o&&o(t.s));for(var a=[],n=s?0:t.t.length,r="undefined"!=typeof t.v,l="undefined"!=typeof t.o,u=0;n>u;++u){var f={time:1e3*t.t[u],close:+t.c[u]};l?(f.open=+t.o[u],f.high=+t.h[u],f.low=+t.l[u]):f.open=f.high=f.low=+f.close,r&&(f.volume=+t.v[u]),a.push(f)}i(a,{noData:s,nextTime:t.nb||t.nextTime})}if(s>0&&(s+"").length>10)throw new Error(["Got a JS time instead of Unix one.",s,a]);return WindowCallback?void n(WindowCallback):void this._send(this._datafeedURL+this._historyURL,{symbol:e.ticker.toUpperCase(),resolution:t,from:s,to:a}).done(function(e){try{var e=parseJSONorNot(JSON.parse(e)),t=e.t;t.length>1?(windowRangTime[0]=Math.max(windowRangTime[0],t[t.length-2]),windowRangTime[1]=Math.max(windowRangTime[1],t[t.length-1])):1==t.length&&(windowRangTime[1]=Math.max(windowRangTime[1],t[t.length-1]));for(var a=8-parseInt(e.gmt),i=0;i<t.length;i++)e.t[i]=parseInt(e.t[i])+60*a*60;n(JSON.stringify(e),s)}catch(o){}}).fail(function(e){console.warn(["getBars(): HTTP error",e]),o&&o("network error: "+JSON.stringify(e))})},Datafeeds.UDFCompatibleDatafeed.prototype.subscribeBars=function(e,t,s,a,i){this._barsPulseUpdater.subscribeDataListener(e,t,s,a,i),(tvWidget.ParentWindowCallback.Varieties!=e.name||tvWidget.ParentWindowCallback.resolution!=t)&&(tvWidget.ParentWindowCallback.Ticker=e.ticker,tvWidget.ParentWindowCallback.Varieties=e.name,tvWidget.ParentWindowCallback.resolution=t,tvWidget.ParentWindowCallback.Callback(e.name,t,e.ticker))},Datafeeds.UDFCompatibleDatafeed.prototype.unsubscribeBars=function(e){this._barsPulseUpdater.unsubscribeDataListener(e)},Datafeeds.UDFCompatibleDatafeed.prototype.calculateHistoryDepth=function(){},Datafeeds.UDFCompatibleDatafeed.prototype.getQuotes=function(e,t,s){this._send(this._datafeedURL+"/quotes",{symbols:e}).done(function(e){var a=parseJSONorNot(e);"ok"===a.s?t&&t(a.d):s&&s(a.errmsg)}).fail(function(e){s&&s("network error: "+e)})},Datafeeds.UDFCompatibleDatafeed.prototype.subscribeQuotes=function(e,t,s,a){this._quotesPulseUpdater.subscribeDataListener(e,t,s,a)},Datafeeds.UDFCompatibleDatafeed.prototype.unsubscribeQuotes=function(e){this._quotesPulseUpdater.unsubscribeDataListener(e)},Datafeeds.SymbolsStorage=function(e){this._datafeed=e,this._exchangesList=["NYSE","FOREX","AMEX"],this._exchangesWaitingForData={},this._exchangesDataCache={},this._symbolsInfo={},this._symbolsList=[],this._requestFullSymbolsList()},Datafeeds.SymbolsStorage.prototype._requestFullSymbolsList=function(){for(var e=this,t=0;t<this._exchangesList.length;++t){var s=this._exchangesList[t];this._exchangesDataCache.hasOwnProperty(s)||(this._exchangesDataCache[s]=!0,this._exchangesWaitingForData[s]="waiting_for_data",this._datafeed._send(this._datafeed._datafeedURL+"/symbol_info",{group:s}).done(function(t){return function(s){e._onExchangeDataReceived(t,parseJSONorNot(s)),e._onAnyExchangeResponseReceived(t)}}(s)).fail(function(t){return function(){e._onAnyExchangeResponseReceived(t)}}(s)))}},Datafeeds.SymbolsStorage.prototype._onExchangeDataReceived=function(e,t){function s(e,t,s){return e[t]instanceof Array?e[t][s]:e[t]}try{for(var a=0;a<t.symbol.length;++a){var i=t.symbol[a],o=s(t,"exchange-listed",a),n=s(t,"exchange-traded",a),r=n+":"+i,l=s(t,"has-intraday",a),u="undefined"!=typeof t.ticker,f={name:i,base_name:[o+":"+i],description:s(t,"description",a),full_name:r,legs:[r],has_intraday:l,has_no_volume:s(t,"has-no-volume",a),listed_exchange:o,exchange:n,minmov:s(t,"minmovement",a)||s(t,"minmov",a),minmove2:s(t,"minmove2",a)||s(t,"minmov2",a),fractional:s(t,"fractional",a),pointvalue:s(t,"pointvalue",a),pricescale:s(t,"pricescale",a),type:s(t,"type",a),session:s(t,"session-regular",a),ticker:u?s(t,"ticker",a):i,timezone:s(t,"timezone",a),supported_resolutions:s(t,"supported-resolutions",a)||this._datafeed.defaultConfiguration().supported_resolutions,force_session_rebuild:s(t,"force-session-rebuild",a)||!1,has_daily:s(t,"has-daily",a)||!0,intraday_multipliers:s(t,"intraday-multipliers",a)||["1","5","15","30","60"],has_weekly_and_monthly:s(t,"has-weekly-and-monthly",a)||!1,has_empty_bars:s(t,"has-empty-bars",a)||!1,volume_precision:s(t,"volume-precision",a)||0};this._symbolsInfo[f.ticker]=this._symbolsInfo[i]=this._symbolsInfo[r]=f,this._symbolsList.push(i)}}catch(d){throw new Error("API error when processing exchange `"+e+"` symbol #"+a+": "+d)}},Datafeeds.SymbolsStorage.prototype._onAnyExchangeResponseReceived=function(e){delete this._exchangesWaitingForData[e];var t=0===Object.keys(this._exchangesWaitingForData).length;t&&(this._symbolsList.sort(),this._datafeed._logMessage("All exchanges data ready"),this._datafeed.onInitialized())},Datafeeds.SymbolsStorage.prototype.resolveSymbol=function(e,t,s){var a=this;setTimeout(function(){a._symbolsInfo.hasOwnProperty(e)?t(a._symbolsInfo[e]):s("invalid symbol")},0)},Datafeeds.SymbolSearchComponent=function(e){this._datafeed=e},Datafeeds.SymbolSearchComponent.prototype.searchSymbols=function(e,t){if(!this._datafeed._symbolsStorage)throw new Error("Cannot use local symbol search when no groups information is available");for(var s=this._datafeed._symbolsStorage,a=[],i=!e.searchString||0===e.searchString.length,o=e.searchString.toUpperCase(),n=0;n<s._symbolsList.length;++n){var r=s._symbolsList[n],l=s._symbolsInfo[r];if(!(e.type&&e.type.length>0&&l.type!==e.type||e.exchange&&e.exchange.length>0&&l.exchange!==e.exchange)){var u=l.name.toUpperCase().indexOf(o),f=l.description.toUpperCase().indexOf(o);if(i||u>=0||f>=0){for(var d=!1,h=0;h<a.length;h++)if(a[h].item===l){d=!0;break}if(!d){var p=u>=0?u:8e3+f;a.push({item:l,weight:p})}}}}e.onResultReadyCallback(a.sort(function(e,t){return e.weight-t.weight}).map(function(e){var t=e.item;return{symbol:t.name,full_name:t.full_name,description:t.description,exchange:t.exchange,params:[],type:t.type,ticker:t.name}}).slice(0,Math.min(a.length,t)))};var update,WindowCallback;Datafeeds.DataPulseUpdater=function(e,t){this._datafeed=e,this._subscribers={},this._requestsPending=0;var s=this;update=function(e){if(WindowCallback=e||null,!(s._requestsPending>0))for(var t in s._subscribers){var a=s._subscribers[t],i=a.resolution,o=parseInt((new Date).valueOf()/1e3),n=o-s.periodLengthSeconds(i,10);s._requestsPending++,function(e){s._datafeed.getBars(e.symbolInfo,i,n,o,function(a){if(s._requestsPending--,s._subscribers.hasOwnProperty(t)&&0!==a.length){var i=a[a.length-1];if(isNaN(e.lastBarTime)||!(i.time<e.lastBarTime)){var o=e.listeners,n=!isNaN(e.lastBarTime)&&i.time>e.lastBarTime;try{if(n){if(a.length<2)throw new Error("Not enough bars in history for proper pulse update. Need at least 2.");for(var r=a[a.length-2],l=0;l<o.length;++l)o[l](r)}}catch(u){}e.lastBarTime=i.time;for(var l=0;l<o.length;++l)o[l](i)}}},function(){s._requestsPending--})}(a)}},"undefined"!=typeof t&&t>0&&setInterval(update,t)},Datafeeds.DataPulseUpdater.prototype.unsubscribeDataListener=function(e){this._datafeed._logMessage("Unsubscribing "+e),delete this._subscribers[e]},Datafeeds.DataPulseUpdater.prototype.subscribeDataListener=function(e,t,s,a){this._datafeed._logMessage("Subscribing "+a),this._subscribers.hasOwnProperty(a)||(this._subscribers[a]={symbolInfo:e,resolution:t,lastBarTime:0/0,listeners:[]}),this._subscribers[a].listeners.push(s)},Datafeeds.DataPulseUpdater.prototype.periodLengthSeconds=function(e,t){var s=0;return s="D"===e?t:"M"===e?31*t:"W"===e?7*t:t*e/1440,24*s*60*60},Datafeeds.QuotesPulseUpdater=function(e){this._datafeed=e,this._subscribers={},this._updateInterval=6e4,this._fastUpdateInterval=1e4,this._requestsPending=0;var t=this;setInterval(function(){t._updateQuotes(function(e){return e.symbols})},this._updateInterval),setInterval(function(){t._updateQuotes(function(e){return e.fastSymbols.length>0?e.fastSymbols:e.symbols})},this._fastUpdateInterval)},Datafeeds.QuotesPulseUpdater.prototype.subscribeDataListener=function(e,t,s,a){this._subscribers.hasOwnProperty(a)||(this._subscribers[a]={symbols:e,fastSymbols:t,listeners:[]}),this._subscribers[a].listeners.push(s)},Datafeeds.QuotesPulseUpdater.prototype.unsubscribeDataListener=function(e){delete this._subscribers[e]},Datafeeds.QuotesPulseUpdater.prototype._updateQuotes=function(e){if(!(this._requestsPending>0)){var t=this;for(var s in this._subscribers){this._requestsPending++;var a=this._subscribers[s];this._datafeed.getQuotes(e(a),function(e,s){return function(a){if(t._requestsPending--,t._subscribers.hasOwnProperty(s))for(var i=0;i<e.length;++i)e[i](a)}}(a.listeners,s),function(){t._requestsPending--})}}},"undefined"!=typeof module&&module&&module.exports&&(module.exports={UDFCompatibleDatafeed:Datafeeds.UDFCompatibleDatafeed});